<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Joyce Window ROI – Manual Price + Discount Drawer</title>
<style>
  :root{
    --brand:#0C5AA6; --brand-600:#0a4a88; --accent:#17a34a; --ink:#17212b;
    --muted:#f4f7fb; --line:#e6edf5; --warn:#fff6e5; --warn-line:#ffe0a6;
    --shadow:0 10px 24px rgba(12, 90, 166, .08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff}
  .wrap{max-width:880px;margin:auto;padding:18px 18px 120px}
  h1{font-size:1.35rem;margin:0 0 6px}
  .sub{margin:0 0 14px;color:#5b6774}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0;box-shadow:var(--shadow)}
  label{display:block;font-size:.95rem;margin:8px 0 6px}
  input[type="number"],input[type="text"],input[type="email"]{
    width:100%;padding:10px;border:1px solid #d6dde6;border-radius:10px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px}.row>*{flex:1}
  @media (max-width:720px){.row{flex-direction:column}}
  .tiers{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid #dfe5ee;border-radius:999px;background:#f8fbff;cursor:pointer}
  .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media (max-width:720px){.kpis{grid-template-columns:1fr}}
  .kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .kpi .val{font-weight:700;font-size:1.1rem}
  .note{font-size:.9rem;color:#5b6774}
  .tiny{font-size:.8rem;color:#6b7280}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-600)}
  .btn-ghost{background:#f8fafc;color:#0b1220;border:1px solid var(--line)}
  .lock{background:var(--warn);border:1px solid var(--warn-line);border-radius:10px;padding:8px;margin-top:6px}
  .blurb{display:flex;justify-content:space-between;align-items:center;gap:12px;background:linear-gradient(90deg, #e9f2ff, #f4fff7);border:1px dashed var(--brand);border-radius:14px;padding:12px}
  .blurb .big{font-size:1.35rem;font-weight:800;color:var(--accent)}
  .slider-wrap{padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--muted)}
  input[type=range]{width:100%}
  .brand{color:var(--brand);font-weight:700}

  /* Bottom Manual Price Drawer */
  .price-tab-handle{
    position:fixed;left:50%;transform:translateX(-50%);bottom:12px;
    background:#fff;border:1px solid var(--line);border-radius:999px;padding:10px 14px;
    font-size:14px;display:flex;align-items:center;gap:10px;cursor:pointer;z-index:1001;box-shadow:var(--shadow)
  }
  .price-tab-handle .chev{
    width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid var(--brand);
    transition:transform .25s ease;
  }
  .price-tab-handle[data-state="closed"] .chev{ transform:rotate(180deg); }
  .price-drawer{
    position:fixed;left:50%;transform:translateX(-50%);bottom:0;
    width:min(920px, calc(100% - 24px));background:#fff;border:1px solid var(--line);border-bottom:none;
    border-radius:14px 14px 0 0;box-shadow:var(--shadow);z-index:1000;overflow:clip;
    transition:max-height .28s ease;max-height:420px;
  }
  .price-drawer[data-state="closed"]{ max-height:0;border-width:0;box-shadow:none; }
  .drawer-inner{ padding: 16px 16px 18px; }
  .drawer-header{ display:flex;align-items:center;gap:10px;margin-bottom:6px }
  .dot{width:9px;height:9px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(23,163,74,.12)}
  .drawer-title{ font-size:15px;font-weight:700;letter-spacing:.2px }
  .drawer-desc{ color:#5b6774;font-size:13px;margin-bottom:12px }
  /* 4 columns: Price | Discount | Notes | Save */
  .field-row{ display:grid;grid-template-columns:1.05fr .75fr 1fr auto;gap:12px;align-items:end }
  @media (max-width:780px){ .field-row{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .field-row{grid-template-columns:1fr} }
  .label{ font-size:12px;color:#6b7280 }
  .input{appearance:none;outline:none;border:1px solid #d6dde6;background:#fff;color:#0b1220;padding:12px;border-radius:12px;font-size:16px;line-height:1.2}
  .help{ font-size:12px;color:#6b6774;margin-top:6px }
  .error{ color:#b91c1c;font-size:12px;margin-top:6px;display:none }
  .error[aria-live="assertive"]{ display:block }

  /* Email modal */
  .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:20px;z-index:1100}
  .modal.open{display:flex}
  .modal .sheet{background:#fff;border-radius:12px;max-width:520px;width:100%;padding:16px;border:1px solid var(--line)}
  .sheet h4{margin:0 0 8px}
  .sheet .row{margin:8px 0}
  .sheet .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .small{font-size:.82rem;color:#5b6670}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>Window ROI Estimator</h1>
  <p class="sub">A fast Joyce estimate using your ZIP and package. We combine <span class="brand">energy savings</span> and <span class="brand">resale recoup</span> over the years you own the home.</p>

  <!-- Inputs -->
  <div class="card">
    <div class="row">
      <div>
        <label for="num">Number of Windows</label>
        <input id="num" type="number" value="10" min="1" step="1" />
      </div>
      <div>
        <label for="zip">ZIP Code</label>
        <input id="zip" type="text" value="44114" maxlength="10" placeholder="e.g., 44114" />
        <div class="note" id="zipNote"></div>
      </div>
    </div>

    <label style="margin-top:8px">Choose Your Package</label>
    <div class="tiers" role="group" aria-label="Good Better Best">
      <label class="pill"><input type="radio" name="tier" value="good" checked> Good <span class="note">($900–$1,100 • J2)</span></label>
      <label class="pill"><input type="radio" name="tier" value="better"> Better <span class="note">($1,250–$1,600 • J31)</span></label>
      <label class="pill"><input type="radio" name="tier" value="best"> Best <span class="note">($1,400–$1,900 • J31)</span></label>
    </div>

    <div id="upgrades">
      <div class="opt"><input type="checkbox" id="paint"><label for="paint" style="margin:0">Painted Exterior (+$300)</label></div>
      <div class="opt"><input type="checkbox" id="hardware"><label for="hardware" style="margin:0">Hardware Upgrade (+$100)</label></div>
      <div class="opt"><input type="checkbox" id="triple"><label for="triple" style="margin:0">Triple‑Pane Glass (+$100)</label></div>
    </div>
    <div id="goodLock" class="lock" style="display:none">
      The <strong>Good</strong> package is as‑is: no upgrades (price varies only by size and type). This keeps “Good” the most economical option.
    </div>
  </div>

  <!-- Total Return Blurb + Years slider -->
  <div class="card">
    <div class="blurb">
      <div>
        <div class="note">Total Return (Savings + Resale <span class="tiny">+ Discount</span>)</div>
        <div class="big" id="totalReturn">$—</div>
      </div>
      <div class="note">Net ROI <span class="tiny">(Return − Cost + Discount)</span>: <strong id="netRoiInline">$—</strong></div>
    </div>

    <div class="slider-wrap" style="margin-top:10px">
      <label for="years"><strong>How long will you live in the home?</strong> <span id="yearsLbl" class="brand">10 years</span></label>
      <input id="years" type="range" min="1" max="20" step="1" value="10" />
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="kpis">
      <div class="kpi">
        <div class="val" id="kCost">$—</div>
        <div class="note">Estimated Installed Cost</div>
        <!-- shows only when a manual price is set -->
        <div id="oopLine" class="tiny" style="display:none;margin-top:6px">
          Estimated Installed Cost <em>after discounts</em>: <strong id="oopVal">$0</strong>
        </div>
      </div>
      <div class="kpi"><div class="val" id="kSave">$—</div><div class="note">Energy Savings (selected years)</div></div>
      <div class="kpi"><div class="val" id="kResale">$—</div><div class="note">Resale Value Recoup</div></div>
      <div class="kpi"><div class="val" id="kROI">$—</div><div class="note">Net ROI (Return − Cost + Discount)</div></div>
    </div>
    <!-- Keep the live “explain” minimal and move details into FAQ -->
    <div class="note" id="explain" style="margin-top:10px">
      See <a href="#faq-calcs">FAQ: How are these numbers calculated?</a>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" id="recalcBtn" type="button">Recalculate</button>
      <button class="btn" style="background:#0b7e3b" onclick="openEmail()">Email me this estimate</button>
    </div>
  </div>

  <!-- FAQ -->
  <div class="card" aria-labelledby="faqTitle">
    <h2 id="faqTitle" style="font-size:1.05rem;margin:0 0 8px">ROI Estimator FAQs</h2>

    <details><summary><strong>How accurate is this estimate?</strong></summary>
      <p class="note">It’s a directional ROI model based on your selections and typical conditions. Final pricing depends on window size, style, installation conditions, and any structural work.</p>
    </details>

    <details><summary><strong>Where does the resale value % come from?</strong></summary>
      <p class="note">We use a ~70% recoup assumption informed by national cost‑vs‑value trends for window projects. It is a planning guide—your local market may vary.</p>
    </details>

    <details><summary><strong>How is energy savings calculated?</strong></summary>
      <p class="note">We start with a baseline $250 monthly bill, apply a rough regional inflation rate derived from your ZIP’s first digit, and multiply by the selected package’s efficiency over the years you plan to stay.</p>
    </details>

    <details><summary><strong>Does a discount change the ROI?</strong></summary>
      <p class="note">Yes—discounts lower your out‑of‑pocket for the same value, so ROI improves. We add the discount dollars to ROI and the main “Total Return” number, but we don’t reduce savings or resale value since product performance is unchanged.</p>
    </details>

    <!-- Calculations/methodology moved here -->
    <details id="faq-calcs"><summary><strong>How are these numbers calculated?</strong></summary>
      <div class="note">
        <ul style="margin:8px 0 0 18px">
          <li><strong>Installed Cost (value anchor)</strong> = either the automatic estimate from package &amp; upgrades (<em>per‑window price × number of windows</em>) or a <em>manual price</em> you enter in the drawer.</li>
          <li><strong>Out‑of‑Pocket (shown under Installed Cost when manual price is set)</strong> = <em>manual price − discount</em> (never below $0). This is also shown on the drawer handle.</li>
          <li><strong>Energy Savings</strong> = sum over each year: <em>(monthly bill × efficiency %) × 12</em>, with the bill increasing annually by your ZIP‑based inflation rate.</li>
          <li><strong>Resale Value Recoup</strong> = <em>Installed Cost × 70%</em> (realized the year you sell/move).</li>
          <li><strong>Total Return (blue blurb)</strong> = <em>Energy Savings + Resale Value + Discount</em>.</li>
          <li><strong>Net ROI</strong> = <em>Total Return − Installed Cost</em> (equivalently <em>Energy Savings + Resale + Discount − Installed</em>).</li>
          <li><strong>Efficiency assumptions</strong>: Good ≈ 18%, Better ≈ 24%, Best ≈ 28%; Triple‑pane adds ≈ +2% when available.</li>
          <li><strong>Inflation by ZIP</strong>: We use a simple heuristic from the first digit of your ZIP to set a regional energy inflation rate (~3–4%/yr).</li>
        </ul>
      </div>
    </details>
  </div>
</div>

<!-- EMAIL MODAL -->
<div id="emailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="emailTitle">
  <div class="sheet">
    <h4 id="emailTitle">Email this estimate</h4>
    <div class="row"><div>
      <label>Your Name</label>
      <input type="text" id="leadName" placeholder="Jane Doe">
    </div></div>
    <div class="row"><div>
      <label>Your Email</label>
      <input type="email" id="leadEmail" placeholder="you@example.com">
    </div></div>
    <div class="small" style="margin-top:6px">We generate a pre‑filled email with your current selections. If your mail app doesn’t open, use “Copy summary.”</div>
    <div class="actions">
      <button type="button" class="btn btn-ghost" onclick="copySummary()">Copy summary</button>
      <button type="button" class="btn" onclick="sendEmail()">Send email</button>
      <button type="button" class="btn btn-ghost" onclick="closeEmail()">Close</button>
    </div>
    <details style="margin-top:10px"><summary class="small">What gets sent?</summary>
      <pre class="mono" id="previewBox" style="white-space:pre-wrap;max-height:220px;overflow:auto;background:#f8fafc;border:1px solid #e8edf3;border-radius:8px;padding:8px"></pre>
    </details>
    <div id="copyMsg" class="small" style="margin-top:6px"></div>
  </div>
</div>

<!-- BOTTOM DRAWER: Manual Project Price -->
<button id="priceTabHandle" class="price-tab-handle" type="button" aria-controls="priceDrawer" aria-expanded="false" data-state="closed">
  <span class="chev" aria-hidden="true"></span>
  <strong>Project Price</strong>
  <span id="priceTabSummary" class="note">$0.00</span>
</button>

<section id="priceDrawer" class="price-drawer" aria-label="Project Price Tab" data-state="closed">
  <div class="drawer-inner">
    <div class="drawer-header">
      <span class="dot" aria-hidden="true"></span>
      <div class="drawer-title">Manual Project Price</div>
    </div>
    <div class="drawer-desc">Enter a project price and an optional discount. The <em>price</em> anchors value (resale &amp; savings). The <em>discount</em> boosts ROI and is included in the blue‑blurb totals.</div>

    <form id="priceForm" novalidate>
      <div class="field-row">
        <div class="field">
          <label for="priceInput" class="label">Price (manual entry)</label>
          <input id="priceInput" class="input" type="text" inputmode="decimal" autocomplete="off" placeholder="$0.00" aria-describedby="priceHelp priceError" />
          <div id="priceHelp" class="help">Enter a number (e.g., 12000, 12,000.50, or $12,000).</div>
          <div id="priceError" class="error" role="alert"></div>
        </div>

        <div class="field">
          <label for="discountInput" class="label">Discount (optional)</label>
          <input id="discountInput" class="input" type="text" inputmode="decimal" autocomplete="off" placeholder="$0.00" aria-describedby="discountHelp discountError" />
          <div id="discountHelp" class="help">Discount improves ROI and blurb totals; it does not reduce savings or resale.</div>
          <div id="discountError" class="error" role="alert"></div>
        </div>

        <div class="field">
          <label for="priceNotes" class="label">Internal note (optional)</label>
          <input id="priceNotes" class="input" type="text" placeholder="e.g., Q4 promo applied" />
        </div>

        <div class="field" style="align-self:center;">
          <button id="savePriceBtn" class="btn" type="submit" title="Save price">Save Price</button>
        </div>
      </div>

      <!-- Hidden raw numeric (cents) -->
      <input type="hidden" id="projectPriceCents" value="0" />
      <input type="hidden" id="projectDiscountCents" value="0" />
    </form>

    <div class="row-actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="clearPriceBtn" class="btn btn-ghost" type="button">Clear</button>
      <button id="closeDrawerBtn" class="btn btn-ghost" type="button">Close</button>
    </div>
  </div>
</section>

<script>
  // ===== Debug beacon =====
  window.__JOYCE_BUILD = 'roi+drawer v1.6 (FAQs refined; moved calc details to FAQ)';
  console.log(window.__JOYCE_BUILD);

  // ---------- Helpers & Constants ----------
  const $ = id => document.getElementById(id);
  const money = n => '$' + Math.round(n).toLocaleString();

  // ZIP → rough regional energy inflation (first digit heuristic, %/yr)
  const inflByZip1st = {'0':4.0,'1':4.0,'2':3.8,'3':3.2,'4':3.2,'5':3.0,'6':3.1,'7':3.3,'8':3.4,'9':3.6};

  // Tier configuration
  const tiers = {
    good:   { label:'Good',   perWindow:1000, eff:18, glass:'J2 (Double Low‑E)',  allowUpgrades:false },
    better: { label:'Better', perWindow:1425, eff:24, glass:'J31 (Quad Low‑E + Super Spacer)', allowUpgrades:true  },
    best:   { label:'Best',   perWindow:1650, eff:28, glass:'J31 (Quad Low‑E + Super Spacer)', allowUpgrades:true  }
  };

  const RECOUP = 0.70;
  const AVG_BILL = 250;

  function currentTier(){ return document.querySelector('input[name="tier"]:checked').value; }

  function applyTierRules(){
    const t = tiers[currentTier()];
    const disable = !t.allowUpgrades;
    ['paint','hardware','triple'].forEach(id=>{
      $(id).checked = false;
      $(id).disabled = disable;
    });
    $('goodLock').style.display = disable ? 'block' : 'none';
    $('upgrades').style.opacity = disable ? .5 : 1;
  }

  function inflationFromZip(zip){
    const firstDigit = (zip.match(/\d/)||[])[0];
    const pct = inflByZip1st[firstDigit] ?? 3.2;
    $('zipNote').textContent = `Regional energy inflation set to ${pct.toFixed(1)}%/yr`;
    return pct/100;
  }

  // ----- Manual Price Drawer utilities -----
  const priceDrawer   = $('priceDrawer');
  const priceHandle   = $('priceTabHandle');
  const priceSummary  = $('priceTabSummary');
  const priceInput    = $('priceInput');
  const discountInput = $('discountInput');
  const priceError    = $('priceError');
  const discountError = $('discountError');
  const priceNotes    = $('priceNotes');
  const hiddenPriceCents    = $('projectPriceCents');
  const hiddenDiscountCents = $('projectDiscountCents');
  const saveBtn  = $('savePriceBtn');
  const clearBtn = $('clearPriceBtn');
  const closeBtn = $('closeDrawerBtn');
  const priceForm= $('priceForm');

  function parseMoneyToCents(raw){
    if (raw == null) return null;
    const cleaned = String(raw).trim()
      .replace(/[^0-9.,-]/g, '')
      .replace(/(,)(?=\d{3}\b)/g, '')
      .replace(/(?!^)-/g,'');
    if (!cleaned) return null;
    let normalized = cleaned;
    const hasComma = cleaned.includes(','), hasDot = cleaned.includes('.');
    normalized = (hasComma && !hasDot) ? cleaned.replace(',','.') : cleaned.replace(/,/g,'');
    const num = Number(normalized);
    if (!isFinite(num)) return null;
    return Math.round(num * 100);
  }
  function formatCents(cents, locale='en-US', currency='USD'){
    const n = (Number(cents)||0)/100;
    try{ return new Intl.NumberFormat(locale,{style:'currency',currency}).format(n); }
    catch{ return '$'+n.toFixed(2); }
  }
  function updatePriceSummary(){
    const p = Number(hiddenPriceCents.value||0);
    const d = Number(hiddenDiscountCents.value||0);
    const oop = Math.max(0, (p - d));
    priceSummary.textContent = `${formatCents(p)} − ${formatCents(d)} = ${formatCents(oop)}`;
  }
  function setDrawerOpen(isOpen){
    priceDrawer.dataset.state = isOpen ? 'open' : 'closed';
    priceHandle.dataset.state = isOpen ? 'open' : 'closed';
    priceHandle.setAttribute('aria-expanded', String(isOpen));
  }
  function setErr(el, msg){
    if (msg){ el.textContent = msg; el.setAttribute('aria-live','assertive'); }
    else { el.textContent = ''; el.removeAttribute('aria-live'); }
  }

  // ----- Core calculator -----
  function calc(){
    const nWindows = Math.max(1, Number($('num').value) || 1);
    const years = Number($('years').value) || 1;
    $('yearsLbl').textContent = years + (years===1?' year':' years');

    const tier = tiers[currentTier()];

    // Auto estimate from tier + upgrades
    let perWindow = tier.perWindow;
    if (tier.allowUpgrades){
      if ($('paint').checked)    perWindow += 300;
      if ($('hardware').checked) perWindow += 100;
      if ($('triple').checked)   perWindow += 100;
    }
    const autoInstalled = perWindow * nWindows;

    // Manual price (optional)
    const manualCents = Number(hiddenPriceCents.value || 0);
    const installed = manualCents > 0 ? (manualCents/100) : autoInstalled;

    // Discount (optional)
    const discount = Math.max(0, Number(hiddenDiscountCents.value || 0) / 100);
    const outOfPocket = Math.max(0, (manualCents/100) - discount); // only meaningful if manual price exists

    // Efficiency / inflation / savings
    const effPct = tier.eff + ((tier.allowUpgrades && $('triple').checked) ? 2 : 0);
    const eff = effPct/100;
    const infl = inflationFromZip($('zip').value.trim());

    let bill = AVG_BILL, savings = 0;
    for (let y=1; y<=years; y++){ savings += bill * eff * 12; bill *= (1 + infl); }

    // Resale based on installed (pre-discount)
    const resale = installed * RECOUP;

    // Totals
    const totalValue = savings + resale;
    const totalReturnForBlurb = totalValue + discount;
    const netROI = totalValue - installed + discount;

    // UI
    $('kCost').textContent   = money(installed);
    $('kSave').textContent   = money(savings);
    $('kResale').textContent = money(resale);
    $('kROI').textContent    = (netROI>=0?'+':'') + money(netROI);

    $('totalReturn').textContent = money(totalReturnForBlurb);
    $('netRoiInline').textContent= (netROI>=0?'+':'') + money(netROI);

    // Show/hide the “after discounts” blurb only when a manual price is set
    if (manualCents > 0){
      $('oopVal').textContent = money(outOfPocket);
      $('oopLine').style.display = 'block';
    } else {
      $('oopLine').style.display = 'none';
    }

    if ($('emailModal').classList.contains('open')) updatePreview();
  }

  // ----- Email modal -----
  function openEmail(){ $('emailModal').classList.add('open'); updatePreview(); }
  function closeEmail(){ $('emailModal').classList.remove('open'); }
  function buildSummary(){
    const t = tiers[currentTier()];
    const years = Number($('years').value)||1;
    const dC = Number(hiddenDiscountCents.value||0);
    return [
      `Joyce Window ROI Estimate`,
      `Package: ${t.label} (${t.glass})`,
      `ZIP: ${$('zip').value.trim()||'—'}`,
      `Windows: ${$('num').value} | Upgrades: ${['paint','hardware','triple'].filter(id=>$(id).checked).join(', ') || 'None'}`,
      `Installed cost: ${$('kCost').textContent}`,
      `Discount: ${formatCents(dC)}`,
      `Energy savings (${years} yr): ${$('kSave').textContent}`,
      `Resale recoup: ${$('kResale').textContent}`,
      `Total Return (Savings + Resale + Discount): ${$('totalReturn').textContent}`,
      `Net ROI (Return − Cost + Discount): ${$('netRoiInline').textContent}`,
      '',
      `Rep note: ${$('priceNotes').value || '—'}`
    ].join('\n');
  }
  function updatePreview(){ $('previewBox').textContent = buildSummary(); }
  function copySummary(){ const txt = buildSummary(); navigator.clipboard.writeText(txt).then(()=>{ $('copyMsg').textContent='Summary copied to clipboard.'; }); }
  function sendEmail(){
    const name = $('leadName').value.trim();
    const email = $('leadEmail').value.trim();
    const subject = encodeURIComponent('My Joyce Window ROI Estimate');
    const body = encodeURIComponent((name?`Name: ${name}\n`:'') + (email?`Email: ${email}\n`:'') + '\n' + buildSummary());
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  // ----- Events wiring -----
  document.addEventListener('input', e=>{
    if (['num','zip','paint','hardware','triple','years','leadName','leadEmail'].includes(e.target.id)) calc();
  });
  document.addEventListener('change', e=>{
    if (e.target.name==='tier'){ applyTierRules(); calc(); }
  });
  $('recalcBtn').addEventListener('click', calc);

  // Drawer interactions
  const priceDrawer = $('priceDrawer'); const priceHandle = $('priceTabHandle'); const closeBtn = $('closeDrawerBtn');
  priceHandle.addEventListener('click', ()=>{ setDrawerOpen(priceDrawer.dataset.state==='closed'); });
  closeBtn.addEventListener('click', ()=> setDrawerOpen(false));

  function formatOnBlur(inputEl, errEl){
    const cents = parseMoneyToCents(inputEl.value);
    if (inputEl.value.trim()===''){ setErr(errEl,''); return null; }
    if (cents==null){ setErr(errEl,'Please enter a valid number.'); return null; }
    inputEl.value = formatCents(cents);
    setErr(errEl,''); return cents;
  }
  const priceInput = $('priceInput'); const discountInput = $('discountInput');
  priceInput.addEventListener('blur', ()=>{ formatOnBlur(priceInput, $('priceError')); });
  discountInput.addEventListener('blur', ()=>{ const c = formatOnBlur(discountInput, $('discountError')); if (c!==null && c<0) setErr($('discountError'), 'Discount cannot be negative.'); });

  $('priceForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const pCents = parseMoneyToCents(priceInput.value);
    const dCents = parseMoneyToCents(discountInput.value || '0');
    if (pCents==null){ setErr($('priceError'),'Please enter a valid number.'); return; }
    if (dCents!=null && dCents<0){ setErr($('discountError'),'Discount cannot be negative.'); return; }
    $('projectPriceCents').value    = String(Math.max(0, pCents));
    $('projectDiscountCents').value = String(Math.max(0, dCents||0));
    updatePriceSummary(); setErr($('priceError'),''); setErr($('discountError'),'');
    window.dispatchEvent(new CustomEvent('projectPriceChanged',{ detail:{
      priceCents: Number($('projectPriceCents').value),
      discountCents: Number($('projectDiscountCents').value),
      note: $('priceNotes').value||null, timestamp:new Date().toISOString()
    }}));
    const btn = $('savePriceBtn'); btn.disabled = true; const old = btn.textContent; btn.textContent='Saved';
    setTimeout(()=>{ btn.disabled=false; btn.textContent=old; }, 800);
    calc();
  });

  $('clearPriceBtn').addEventListener('click', ()=>{
    priceInput.value=''; discountInput.value=''; $('priceNotes').value='';
    $('projectPriceCents').value=0; $('projectDiscountCents').value=0;
    updatePriceSummary(); setErr($('priceError'),''); setErr($('discountError'),'');
    window.dispatchEvent(new CustomEvent('projectPriceChanged',{ detail:{ priceCents:0, discountCents:0, note:null, timestamp:new Date().toISOString() }}));
    calc();
  });

  // Init
  applyTierRules();
  setDrawerOpen(false);     // closed by default
  updatePriceSummary();
  calc();
</script>
</body>
</html>

