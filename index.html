<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Joyce Window ROI – Simple (Years + Email)</title>
<style>
  :root{
    --brand:#0C5AA6;      /* Joyce deep blue */
    --brand-600:#0a4a88;
    --accent:#17a34a;     /* positive green */
    --ink:#17212b;
    --muted:#f4f7fb;
    --line:#e6edf5;
    --warn:#fff6e5;
    --warn-line:#ffe0a6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff}
  .wrap{max-width:880px;margin:auto;padding:18px}
  h1{font-size:1.35rem;margin:0 0 6px}
  .sub{margin:0 0 14px;color:#5b6774}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
  label{display:block;font-size:.95rem;margin:8px 0 6px}
  input[type="number"],input[type="text"],input[type="email"]{
    width:100%;padding:10px;border:1px solid #d6dde6;border-radius:10px;font-size:1rem;background:#fff
  }
  .row{display:flex;gap:12px}.row>*{flex:1}
  @media (max-width:720px){.row{flex-direction:column}}
  .tiers{display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    display:flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid #dfe5ee;border-radius:999px;
    background:#f8fbff;cursor:pointer
  }
  .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media (max-width:720px){.kpis{grid-template-columns:1fr}}
  .kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  .kpi .val{font-weight:700;font-size:1.1rem}
  .note{font-size:.9rem;color:#5b6774}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-600)}
  .disabled{opacity:.5;pointer-events:none}
  .lock{background:var(--warn);border:1px solid var(--warn-line);border-radius:10px;padding:8px;margin-top:6px}
  .blurb{
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    background:linear-gradient(90deg, #e9f2ff, #f4fff7);
    border:1px dashed var(--brand);border-radius:14px;padding:12px
  }
  .blurb .big{font-size:1.35rem;font-weight:800;color:var(--accent)}
  .slider-wrap{padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--muted)}
  input[type=range]{width:100%}
  .brand{color:var(--brand);font-weight:700}

  /* Modal (Email) */
  .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:20px;z-index:1000}
  .modal.open{display:flex}
  .modal .sheet{background:#fff;border-radius:12px;max-width:520px;width:100%;padding:16px;border:1px solid #dfe5ee}
  .sheet h4{margin:0 0 8px}
  .sheet .row{margin:8px 0}
  .sheet .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .small{font-size:.82rem;color:#5b6670}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>Window ROI Estimator</h1>
  <p class="sub">A fast Joyce estimate using your ZIP and package. We combine <span class="brand">energy savings</span> and <span class="brand">resale recoup</span> over the years you own the home.</p>

  <!-- Inputs -->
  <div class="card">
    <div class="row">
      <div>
        <label for="num">Number of Windows</label>
        <input id="num" type="number" value="10" min="1" step="1" />
      </div>
      <div>
        <label for="zip">ZIP Code</label>
        <input id="zip" type="text" value="44114" maxlength="10" placeholder="e.g., 44114" />
        <div class="note" id="zipNote"></div>
      </div>
    </div>

    <label style="margin-top:8px">Choose Your Package</label>
    <div class="tiers" role="group" aria-label="Good Better Best">
      <label class="pill"><input type="radio" name="tier" value="good" checked> Good <span class="note">($900–$1,100 • J2)</span></label>
      <label class="pill"><input type="radio" name="tier" value="better"> Better <span class="note">($1,250–$1,600 • J31)</span></label>
      <label class="pill"><input type="radio" name="tier" value="best"> Best <span class="note">($1,400–$1,900 • J31)</span></label>
    </div>

    <div id="upgrades">
      <div class="opt"><input type="checkbox" id="paint"><label for="paint" style="margin:0">Painted Exterior (+$300)</label></div>
      <div class="opt"><input type="checkbox" id="hardware"><label for="hardware" style="margin:0">Hardware Upgrade (+$100)</label></div>
      <div class="opt"><input type="checkbox" id="triple"><label for="triple" style="margin:0">Triple‑Pane Glass (+$100)</label></div>
    </div>
    <div id="goodLock" class="lock" style="display:none">
      The <strong>Good</strong> package is as‑is: no upgrades (price varies only by size and type). This keeps “Good” the most economical option.
    </div>
  </div>

  <!-- Total Return Blurb + Years slider -->
  <div class="card">
    <div class="blurb">
      <div>
        <div class="note">Total Return (Savings + Resale Recoup)</div>
        <div class="big" id="totalReturn">$—</div>
      </div>
      <div class="note">Net ROI (after cost): <strong id="netRoiInline">$—</strong></div>
    </div>

    <div class="slider-wrap" style="margin-top:10px">
      <label for="years"><strong>How long will you live in the home?</strong> <span id="yearsLbl" class="brand">10 years</span></label>
      <input id="years" type="range" min="1" max="20" step="1" value="10" />
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="kpis">
      <div class="kpi"><div class="val" id="kCost">$—</div><div class="note">Estimated Installed Cost</div></div>
      <div class="kpi"><div class="val" id="kSave">$—</div><div class="note">Energy Savings (selected years)</div></div>
      <div class="kpi"><div class="val" id="kResale">$—</div><div class="note">Resale Value Recoup</div></div>
      <div class="kpi"><div class="val" id="kROI">$—</div><div class="note">Net ROI (Return − Cost)</div></div>
    </div>
    <div class="note" id="explain" style="margin-top:10px"></div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" onclick="calc()">Recalculate</button>
      <button class="btn" style="background:#0b7e3b" onclick="openEmail()">Email me this estimate</button>
    </div>
  </div>

  <p class="note">
    Assumptions: Resale recoup of 70% at the year you move (est.) • Energy bill inflation varies by ZIP region • Efficiency assumptions:
    Good (J2 double Low‑E) ≈18%, Better (J31 + Super Spacer) ≈24%, Best (J31) ≈28% (Triple‑pane adds +2%). Prices vary by size/type.
  </p>
</div>

<!-- EMAIL MODAL -->
<div id="emailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="emailTitle">
  <div class="sheet">
    <h4 id="emailTitle">Email this estimate</h4>
    <div class="row"><div>
      <label>Your Name</label>
      <input type="text" id="leadName" placeholder="Jane Doe">
    </div></div>
    <div class="row"><div>
      <label>Your Email</label>
      <input type="email" id="leadEmail" placeholder="you@example.com">
    </div></div>
    <div class="small" style="margin-top:6px">We generate a pre‑filled email with your current selections. If your mail app doesn’t open, use “Copy summary.”</div>
    <div class="actions">
      <button type="button" class="btn" style="background:#f3f6fa;color:#0b1220;border:1px solid #dfe5ee" onclick="copySummary()">Copy summary</button>
      <button type="button" class="btn" onclick="sendEmail()">Send email</button>
      <button type="button" class="btn" style="background:#f3f6fa;color:#0b1220;border:1px solid #dfe5ee" onclick="closeEmail()">Close</button>
    </div>
    <details style="margin-top:10px"><summary class="small">What gets sent?</summary>
      <pre class="mono" id="previewBox" style="white-space:pre-wrap;max-height:220px;overflow:auto;background:#f8fafc;border:1px solid #e8edf3;border-radius:8px;padding:8px"></pre>
    </details>
    <div id="copyMsg" class="small" style="margin-top:6px"></div>
  </div>
</div>

<script>
  // ---------- Helpers & Constants ----------
  const $ = id => document.getElementById(id);
  const money = n => '$' + Math.round(n).toLocaleString();

  // ZIP → rough regional energy inflation (first digit heuristic, %/yr)
  const inflByZip1st = {'0':4.0,'1':4.0,'2':3.8,'3':3.2,'4':3.2,'5':3.0,'6':3.1,'7':3.3,'8':3.4,'9':3.6};

  // Tier configuration
  const tiers = {
    good:   { label:'Good',   perWindow:1000, eff:18, glass:'J2 (Double Low‑E)',  allowUpgrades:false },
    better: { label:'Better', perWindow:1425, eff:24, glass:'J31 (Quad Low‑E + Super Spacer)', allowUpgrades:true  },
    best:   { label:'Best',   perWindow:1650, eff:28, glass:'J31 (Quad Low‑E + Super Spacer)', allowUpgrades:true  }
  };

  // Hidden defaults
  const RECOUP = 0.70;        // percent of installed cost recouped at resale
  const AVG_BILL = 250;       // baseline monthly bill if none collected

  function currentTier(){ return document.querySelector('input[name="tier"]:checked').value; }

  function applyTierRules(){
    const t = tiers[currentTier()];
    const disable = !t.allowUpgrades;
    ['paint','hardware','triple'].forEach(id=>{
      $(id).checked = false;
      $(id).disabled = disable;
    });
    $('goodLock').style.display = disable ? 'block' : 'none';
    $('upgrades').style.opacity = disable ? .5 : 1;
  }

  function inflationFromZip(zip){
    const firstDigit = (zip.match(/\d/)||[])[0];
    const pct = inflByZip1st[firstDigit] ?? 3.2;
    $('zipNote').textContent = `Regional energy inflation set to ${pct.toFixed(1)}%/yr`;
    return pct/100;
  }

  function calc(){
    const nWindows = Math.max(1, +$('num').value||1);
    const years = +$('years').value;
    $('yearsLbl').textContent = years + (years===1?' year':' years');

    const tierKey = currentTier();
    const tier = tiers[tierKey];

    // Base per-window price + permitted upgrades
    let perWindow = tier.perWindow;
    if (tier.allowUpgrades){
      if ($('paint').checked)    perWindow += 300;
      if ($('hardware').checked) perWindow += 100;
      if ($('triple').checked)   perWindow += 100;
    }
    const installed = perWindow * nWindows;

    // Efficiency
    let effPct = tier.eff + ((tier.allowUpgrades && $('triple').checked) ? 2 : 0);
    const eff = effPct/100;

    // Inflation via ZIP
    const infl = inflationFromZip($('zip').value.trim());

    // Energy savings across chosen years (bill inflates each year)
    let bill = AVG_BILL, savings = 0;
    for (let y=1; y<=years; y++){
      savings += bill * eff * 12; // year's savings
      bill *= (1 + infl);
    }

    // Resale recoup realized when they sell/move at selected year
    const resale = installed * RECOUP;

    // Totals
    const totalReturn = savings + resale;           // what they "get back" before cost
    const netROI = totalReturn - installed;         // benefit net of cost

    // Output
    $('kCost').textContent = money(installed);
    $('kSave').textContent = money(savings);
    $('kResale').textContent = money(resale);
    $('kROI').textContent = (netROI>=0?'+':'') + money(netROI);

    $('totalReturn').textContent = money(totalReturn);
    $('netRoiInline').textContent = (netROI>=0?'+':'') + money(netROI);

    $('explain').innerHTML =
      `Includes ${Math.round(RECOUP*100)}% resale value at <strong>year ${years}</strong> + cumulative energy savings with ` +
      `regional energy inflation of <strong>${(infl*100).toFixed(1)}%/yr</strong>, assuming <strong>${effPct}%</strong> efficiency for ` +
      `<strong>${tier.label}</strong> (${tier.glass}).`;

    // Update email preview if modal is open
    if (document.getElementById('emailModal').classList.contains('open')) updatePreview();
  }

  // --- Email modal helpers ---
  function openEmail(){ document.getElementById('emailModal').classList.add('open'); updatePreview(); }
  function closeEmail(){ document.getElementById('emailModal').classList.remove('open'); }
  function buildSummary(){
    const tierKey = currentTier(); const t = tiers[tierKey];
    const years = +$('years').value;
    const totalReturn = $('totalReturn').textContent;
    const netInline = $('netRoiInline').textContent;
    return [
      `Joyce Window ROI Estimate`,
      `Package: ${t.label} (${t.glass})`,
      `ZIP: ${$('zip').value.trim()||'—'}`,
      `Windows: ${$('num').value} | Upgrades: ${
        ['paint','hardware','triple'].filter(id=>$(id).checked).join(', ')||'None'
      }`,
      `Total Return at ${years} years (Savings + Resale): ${totalReturn}`,
      `Net ROI (after cost): ${netInline}`,
      ``,
      `Breakdown`,
      `Installed cost: ${$('kCost').textContent}`,
      `Energy savings (${years} yr): ${$('kSave').textContent}`,
      `Resale recoup: ${$('kResale').textContent}`
    ].join('\n');
  }
  function updatePreview(){ $('previewBox').textContent = buildSummary(); }
  function copySummary(){
    const txt = buildSummary();
    navigator.clipboard.writeText(txt).then(()=>{ document.getElementById('copyMsg').textContent='Summary copied to clipboard.'; });
  }
  function sendEmail(){
    const name = document.getElementById('leadName').value.trim();
    const email = document.getElementById('leadEmail').value.trim();
    const subject = encodeURIComponent('My Joyce Window ROI Estimate');
    const body = encodeURIComponent((name?`Name: ${name}\n`:'') + (email?`Email: ${email}\n`:'') + '\n' + buildSummary());
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  // Wire events
  document.addEventListener('change', e=>{
    if (e.target.name==='tier'){ applyTierRules(); }
    calc();
  });
  document.addEventListener('input', e=>{
    if (['num','zip','paint','hardware','triple','years','leadName','leadEmail'].includes(e.target.id)) {
      calc();
    }
  });

  // Init
  applyTierRules(); calc();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tool with Bottom Price Tab</title>
  <style>
    :root{
      --ec-bg:#0f172a;        /* slate-900 */
      --ec-surface:#111827;   /* gray-900 */
      --ec-card:#1f2937;      /* gray-800 */
      --ec-text:#f8fafc;      /* slate-50 */
      --ec-muted:#94a3b8;     /* slate-400 */
      --ec-accent:#22c55e;    /* green-500 */
      --ec-danger:#ef4444;    /* red-500 */
      --ec-border:#334155;    /* slate-700 */
      --shadow: 0 8px 24px rgba(0,0,0,.3);
      --radius: 16px;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--ec-bg);
      color:var(--ec-text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* Demo content area (replace with your tool/app) */
    .app-shell{
      min-height:100%;
      box-sizing:border-box;
      padding:24px 24px 120px; /* bottom padding leaves room for the tab */
    }
    .demo-card{
      background:var(--ec-card);
      border:1px solid var(--ec-border);
      border-radius: var(--radius);
      padding:24px;
      max-width:900px;
      margin:0 auto;
      box-shadow: var(--shadow);
    }

    /* Bottom Tab (collapsed handle) */
    .price-tab-handle{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:12px;
      background:var(--ec-surface);
      color:var(--ec-text);
      border:1px solid var(--ec-border);
      border-radius: var(--radius);
      padding:10px 14px;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .price-tab-handle .chev{
      display:inline-block;
      width: 0; height: 0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--ec-text); /* up by default (open) */
      transition: transform .25s ease;
    }
    .price-tab-handle[data-state="closed"] .chev{
      transform: rotate(180deg); /* points down when closed */
    }

    /* Bottom Drawer */
    .price-drawer{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom:0;
      width:min(920px, calc(100% - 24px));
      background:var(--ec-surface);
      border:1px solid var(--ec-border);
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: var(--shadow);
      z-index: 1000;
      overflow:clip;
      transition: max-height .28s ease;
      max-height: 420px; /* open */
    }
    .price-drawer[data-state="closed"]{
      max-height: 0; /* hidden but mounted for smoother open */
      border-width:0;
      box-shadow:none;
    }
    .drawer-inner{
      padding: 18px 18px 20px;
    }

    .drawer-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom: 12px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--ec-accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
    }
    .drawer-title{
      font-size: 15px;
      font-weight: 600;
      letter-spacing:.2px;
    }
    .drawer-desc{
      color: var(--ec-muted);
      font-size: 13px;
      margin-bottom: 16px;
    }

    /* Form */
    .field-row{
      display:grid;
      grid-template-columns: 1.2fr .8fr auto;
      gap:12px;
      align-items:end;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap:6px;
    }
    .label{
      font-size: 12px;
      color: var(--ec-muted);
    }
    .input{
      appearance:none;
      outline:none;
      border:1px solid var(--ec-border);
      background: var(--ec-bg);
      color: var(--ec-text);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 16px;
      line-height: 1.2;
      transition: border-color .2s ease, box-shadow .2s ease;
      width:100%;
    }
    .input:focus{
      border-color: var(--ec-accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
    }
    .help{
      font-size:12px;color:var(--ec-muted);margin-top:6px;
    }

    .btn{
      appearance:none;border:0;cursor:pointer;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .02s ease, filter .2s ease;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background:var(--ec-accent); color:#052e16;
    }
    .btn-ghost{
      background:transparent; color:var(--ec-text);
      border:1px solid var(--ec-border);
    }
    .btn[disabled]{
      opacity:.6; cursor:not-allowed;
    }

    .row-actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top: 14px;
    }

    .error{
      color: var(--ec-danger);
      font-size: 12px;
      margin-top: 6px;
      display:none;
    }
    .error[aria-live="assertive"]{ display:block; }

    @media (max-width:700px){
      .field-row{
        grid-template-columns: 1fr;
        align-items:stretch;
      }
      .row-actions{ justify-content: stretch; }
      .btn{ justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Replace this block with your existing tool UI -->
    <div class="demo-card">
      <h2 style="margin:0 0 8px;">Your Tool</h2>
      <p style="margin:0;color:var(--ec-muted)">
        Demo content area. The sticky bottom tab below lets reps manually enter a Project Price any time.
      </p>
    </div>
  </div>

  <!-- Collapsed handle / toggle -->
  <button id="priceTabHandle" class="price-tab-handle" type="button" aria-controls="priceDrawer" aria-expanded="true">
    <span class="chev" aria-hidden="true"></span>
    <strong>Project Price</strong>
    <span id="priceTabSummary" style="color:var(--ec-muted)">$0.00</span>
  </button>

  <!-- Bottom drawer -->
  <section id="priceDrawer" class="price-drawer" aria-label="Project Price Tab" data-state="open">
    <div class="drawer-inner">
      <div class="drawer-header">
        <span class="dot" aria-hidden="true"></span>
        <div class="drawer-title">Manual Project Price</div>
      </div>
      <div class="drawer-desc">
        Reps can enter or adjust the price for this project. Value is stored and broadcast to your app.
      </div>

      <form id="priceForm" novalidate>
        <div class="field-row">
          <div class="field">
            <label for="priceInput" class="label">Price (manual entry)</label>
            <input
              id="priceInput"
              class="input"
              type="text"
              inputmode="decimal"
              autocomplete="off"
              placeholder="$0.00"
              aria-describedby="priceHelp priceError"
              data-locale="en-US"
              data-currency="USD"
            />
            <div id="priceHelp" class="help">Enter a number (e.g., 12000, 12,000.50, or $12,000).</div>
            <div id="priceError" class="error" role="alert"></div>
          </div>

          <div class="field">
            <label for="priceNotes" class="label">Internal note (optional)</label>
            <input id="priceNotes" class="input" type="text" placeholder="e.g., Discount applied for Q4 promo" />
          </div>

          <div class="field" style="align-self:center;">
            <button id="savePriceBtn" class="btn btn-primary" type="submit" title="Save price">
              Save Price
            </button>
          </div>
        </div>

        <!-- Hidden raw numeric (cents) for easy machine use -->
        <input type="hidden" id="projectPriceCents" value="0" />
      </form>

      <div class="row-actions">
        <button id="clearPriceBtn" class="btn btn-ghost" type="button">Clear</button>
        <button id="closeDrawerBtn" class="btn btn-ghost" type="button">Close</button>
      </div>
    </div>
  </section>

  <script>
    // -------- Utilities
    const $ = (sel, root=document) => root.querySelector(sel);

    function parseMoneyToCents(raw){
      if (raw == null) return null;
      // Strip everything except digits, dot, and comma
      const cleaned = String(raw).trim()
        .replace(/[^0-9.,-]/g, '')
        .replace(/(,)(?=\d{3}\b)/g, '') // drop thousands commas like 12,345
        .replace(/(?!^)-/g,''); // keep only leading minus if any
      if (!cleaned) return null;

      // If both comma and dot exist, assume dot is decimal
      let normalized = cleaned;
      const hasComma = cleaned.includes(',');
      const hasDot = cleaned.includes('.');
      if (hasComma && !hasDot){
        // Treat comma as decimal (e.g., 123,45)
        normalized = cleaned.replace(',','.');
      } else {
        // remove any lingering commas
        normalized = cleaned.replace(/,/g,'');
      }

      const num = Number(normalized);
      if (!isFinite(num)) return null;

      // Round to cents
      return Math.round(num * 100);
    }

    function formatCents(cents, locale='en-US', currency='USD'){
      const n = (Number(cents)||0)/100;
      try{
        return new Intl.NumberFormat(locale, { style:'currency', currency }).format(n);
      }catch{
        return `$${n.toFixed(2)}`;
      }
    }

    // -------- Elements
    const drawer = $("#priceDrawer");
    const handle = $("#priceTabHandle");
    const summary = $("#priceTabSummary");
    const priceInput = $("#priceInput");
    const priceError = $("#priceError");
    const hiddenCents = $("#projectPriceCents");
    const saveBtn = $("#savePriceBtn");
    const clearBtn = $("#clearPriceBtn");
    const closeBtn = $("#closeDrawerBtn");
    const form = $("#priceForm");

    // State
    function setOpen(isOpen){
      drawer.dataset.state = isOpen ? 'open' : 'closed';
      handle.dataset.state = isOpen ? 'open' : 'closed';
      handle.setAttribute('aria-expanded', String(isOpen));
    }

    function updateSummary(){
      summary.textContent = formatCents(hiddenCents.value || 0, priceInput.dataset.locale, priceInput.dataset.currency);
    }

    function setError(msg){
      if (msg){
        priceError.textContent = msg;
        priceError.setAttribute('aria-live','assertive');
      }else{
        priceError.textContent = '';
        priceError.removeAttribute('aria-live');
      }
    }

    // Format on blur for nice display (keeps raw in hidden)
    priceInput.addEventListener('blur', () => {
      const cents = parseMoneyToCents(priceInput.value);
      if (cents == null){
        // allow empty
        if (priceInput.value.trim() === ''){
          hiddenCents.value = 0;
          updateSummary();
          setError('');
          return;
        }
        setError('Please enter a valid number.');
        return;
      }
      priceInput.value = formatCents(cents, priceInput.dataset.locale, priceInput.dataset.currency);
      setError('');
    });

    // Save
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const cents = parseMoneyToCents(priceInput.value);
      if (cents == null){
        setError('Please enter a valid number.');
        return;
      }
      hiddenCents.value = String(cents);
      setError('');
      updateSummary();

      // Emit a detail event so the rest of your tool can react
      const detail = {
        cents,
        value: (cents/100),
        formatted: formatCents(cents, priceInput.dataset.locale, priceInput.dataset.currency),
        note: $("#priceNotes").value || null,
        timestamp: new Date().toISOString()
      };
      window.dispatchEvent(new CustomEvent('projectPriceChanged', { detail }));

      // Provide a quick visual feedback (disable briefly)
      saveBtn.disabled = true;
      saveBtn.textContent = "Saved";
      setTimeout(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Price";
      }, 800);
    });

    // Clear
    clearBtn.addEventListener('click', () => {
      priceInput.value = '';
      hiddenCents.value = 0;
      $("#priceNotes").value = '';
      updateSummary();
      setError('');
      window.dispatchEvent(new CustomEvent('projectPriceChanged', {
        detail: { cents: 0, value: 0, formatted: formatCents(0, priceInput.dataset.locale, priceInput.dataset.currency), note: null, timestamp: new Date().toISOString() }
      }));
    });

    // Toggle
    handle.addEventListener('click', () => {
      const isClosed = drawer.dataset.state === 'closed';
      setOpen(isClosed);
    });
    closeBtn.addEventListener('click', () => setOpen(false));

    // Initialize
    (function init(){
      setOpen(true);
      updateSummary();

      // Example: listen elsewhere in your app
      // window.addEventListener('projectPriceChanged', (e)=>console.log('Price updated:', e.detail));
    })();
  </script>
</body>
</html>

